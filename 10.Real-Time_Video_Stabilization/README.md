# Real-Time Video Stabilization with CUDA

GPU-accelerated video stabilization using optical flow and motion estimation. This project implements real-time video stabilization on NVIDIA GPUs using CUDA.

## Features

- **GPU-Accelerated Processing**: All computationally intensive operations run on the GPU
- **Multiple Optical Flow Methods**: Lucas-Kanade and Horn-Schunck implementations
- **Advanced Motion Estimation**: Block matching with three-step search algorithm
- **Trajectory Smoothing**: Moving average, Gaussian, and Kalman filter options
- **Real-Time Processing**: Webcam support for live video stabilization
- **Two-Pass Mode**: Higher quality offline processing for video files

## System Requirements

- **GPU**: NVIDIA RTX 4070 or compatible (Compute Capability 8.9)
- **CUDA**: 12.6 or later
- **OpenCV**: 4.10.0 or later
- **CMake**: 3.18 or later
- **Compiler**: GCC with C++17 support

## Project Structure

```
10.Real-Time_Video_Stabilization/
├── CMakeLists.txt
├── build.sh
├── README.md
├── include/
│   ├── common.hpp              # Common types and utilities
│   ├── optical_flow.cuh        # Optical flow CUDA interface
│   ├── motion_estimation.cuh   # Motion estimation interface
│   ├── frame_warping.cuh       # Frame transformation interface
│   ├── gaussian_pyramid.cuh    # Multi-scale processing
│   ├── video_stabilizer.hpp    # Main stabilizer class
│   ├── trajectory_smoother.hpp # Trajectory smoothing
│   └── memory_manager.hpp      # GPU memory management
├── src/
│   ├── cuda/
│   │   ├── optical_flow.cu       # Lucas-Kanade, Horn-Schunck
│   │   ├── motion_estimation.cu  # Block matching, feature tracking
│   │   ├── frame_warping.cu      # Affine/perspective transforms
│   │   └── gaussian_pyramid.cu   # Multi-scale operations
│   ├── cpp/
│   │   ├── video_stabilizer.cpp  # Main stabilizer implementation
│   │   ├── trajectory_smoother.cpp
│   │   └── memory_manager.cpp
│   └── main.cpp
├── data/                        # Sample videos
├── tools/                       # Utility scripts
└── python/                      # Python bindings (optional)
```

## Building

```bash
# Quick build
./build.sh

# Or manual build
mkdir build && cd build
cmake -DCMAKE_BUILD_TYPE=Release ..
make -j$(nproc)
```

## Usage

### Process Video File

```bash
# Basic usage
./video_stabilizer -i shaky_video.mp4 -o stable_video.mp4

# With custom parameters
./video_stabilizer -i input.mp4 -o output.mp4 -s 50 -r 0.85

# Show comparison
./video_stabilizer -i input.mp4 -o output.mp4 -p
```

### Real-Time from Webcam

```bash
# Default camera
./video_stabilizer -c 0

# With comparison view
./video_stabilizer -c 0 -p
```

### Command Line Options

| Option | Description | Default |
|--------|-------------|---------|
| `-i, --input` | Input video file | - |
| `-o, --output` | Output video file | output.mp4 |
| `-c, --camera` | Camera ID for real-time | 0 |
| `-s, --smoothing` | Smoothing radius (frames) | 30 |
| `-r, --crop` | Crop ratio (0.0-1.0) | 0.9 |
| `-g, --gpu` | Force GPU processing | auto |
| `-p, --compare` | Show before/after comparison | off |
| `-m, --method` | Smoothing: average/gaussian/kalman | gaussian |
| `-h, --help` | Show help message | - |

## Algorithm Overview

### 1. Motion Estimation

The stabilizer uses a combination of:
- **Feature Detection**: Harris corner detection for robust feature points
- **Optical Flow**: Lucas-Kanade pyramidal optical flow for tracking
- **RANSAC**: Outlier rejection for robust transform estimation

### 2. Trajectory Computation

Frame-to-frame transforms are accumulated into a camera trajectory:
- Translation (dx, dy)
- Rotation (angle)
- Scale (optional)

### 3. Trajectory Smoothing

Three smoothing methods available:
- **Moving Average**: Simple and fast
- **Gaussian**: Better frequency response
- **Kalman Filter**: Predictive smoothing

### 4. Frame Warping

Stabilized frames are generated by:
1. Computing the difference between original and smoothed trajectory
2. Applying inverse affine transformation
3. Cropping borders to hide artifacts

## Performance

Benchmarks on RTX 4070 (8GB):

| Resolution | Mode | FPS |
|------------|------|-----|
| 1920x1080 | Real-time | ~45-60 |
| 1280x720 | Real-time | ~90-120 |
| 3840x2160 | Offline | ~15-20 |

## CUDA Kernels

### Optical Flow (`optical_flow.cu`)
- Sobel gradient computation
- Lucas-Kanade iterative solver
- Horn-Schunck global flow

### Motion Estimation (`motion_estimation.cu`)
- Block matching with SAD metric
- Three-step search optimization
- Harris corner detection
- Feature point tracking

### Frame Warping (`frame_warping.cu`)
- Affine transformation
- Bilinear interpolation
- Border handling modes

### Gaussian Pyramid (`gaussian_pyramid.cu`)
- Separable Gaussian blur
- 2x downsampling/upsampling
- Laplacian pyramid construction

## References

1. Lucas, B. D., & Kanade, T. (1981). An iterative image registration technique
2. Horn, B. K., & Schunck, B. G. (1981). Determining optical flow
3. Grundmann, M., et al. (2011). Auto-directed video stabilization with robust L1 optimal camera paths

## License

MIT License - See LICENSE file for details.
